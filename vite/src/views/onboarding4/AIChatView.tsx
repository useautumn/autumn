import { ArrowLeft, MessageSquareText } from "lucide-react";
import { useState } from "react";
import { useNavigate } from "react-router";
import {
	Conversation,
	ConversationContent,
	ConversationEmptyState,
} from "@/components/ai-elements/conversation";
import { Loader } from "@/components/ai-elements/loader";
import {
	Message,
	MessageContent,
	MessageResponse,
} from "@/components/ai-elements/message";
import {
	PromptInput,
	PromptInputBody,
	PromptInputFooter,
	type PromptInputMessage,
	PromptInputSubmit,
	PromptInputTextarea,
} from "@/components/ai-elements/prompt-input";
import { Button } from "@/components/v2/buttons/Button";
import { pushPage } from "@/utils/genUtils";
import { PricingPreview } from "./PricingPreview";
import type { PricingTier } from "./templateConfigs";

interface ChatMessage {
	id: string;
	role: "user" | "assistant";
	content: string;
}

interface AIChatViewProps {
	onBack: () => void;
}

// Mock pricing tiers that would be generated by the AI
const MOCK_GENERATED_TIERS: PricingTier[] = [
	{
		name: "Free",
		price: "Free",
		description: "For individuals",
		features: ["Basic features", "Community support", "Limited usage"],
	},
	{
		name: "Pro",
		price: "$29",
		interval: "month",
		description: "For professionals",
		features: [
			"All free features",
			"Priority support",
			"Advanced analytics",
			"Unlimited usage",
		],
		highlighted: true,
	},
	{
		name: "Enterprise",
		price: "Custom",
		description: "For teams",
		features: [
			"Everything in Pro",
			"Dedicated support",
			"Custom integrations",
			"SLA guarantees",
		],
	},
];

export function AIChatView({ onBack }: AIChatViewProps) {
	const navigate = useNavigate();
	const [input, setInput] = useState("");
	const [messages, setMessages] = useState<ChatMessage[]>([]);
	const [isLoading, setIsLoading] = useState(false);
	const [pricingTiers, setPricingTiers] = useState<PricingTier[]>([]);

	const handleCopyPlans = () => {
		pushPage({ path: "/products", navigate });
	};

	const handleSubmit = (message: PromptInputMessage) => {
		if (!message.text.trim()) return;

		const userMessage: ChatMessage = {
			id: crypto.randomUUID(),
			role: "user",
			content: message.text,
		};

		setMessages((prev) => [...prev, userMessage]);
		setInput("");
		setIsLoading(true);

		// Simulate AI response and pricing generation
		setTimeout(() => {
			const assistantMessage: ChatMessage = {
				id: crypto.randomUUID(),
				role: "assistant",
				content:
					"Based on your description, I've created a pricing model with three tiers. The **Free** tier includes basic features for individuals getting started. The **Pro** tier at $29/month is designed for professionals who need advanced capabilities. Finally, the **Enterprise** tier offers custom pricing for teams with dedicated support.\n\nWould you like me to adjust any of these tiers?",
			};
			setMessages((prev) => [...prev, assistantMessage]);
			setPricingTiers(MOCK_GENERATED_TIERS);
			setIsLoading(false);
		}, 1500);
	};

	return (
		<div className="w-full h-full flex flex-col bg-background">
			{/* Header */}
			<div className="flex items-center gap-3 px-6 py-4 border-b">
				<button
					type="button"
					onClick={onBack}
					className="p-1.5 rounded-lg hover:bg-interactive-secondary transition-colors"
				>
					<ArrowLeft className="size-5 text-t2" />
				</button>
				<h1 className="text-lg font-medium text-foreground">
					Describe your pricing
				</h1>
			</div>

			{/* Main content - split view */}
			<div className="flex-1 flex min-h-0">
				{/* Left: Chat */}
				<div className="w-1/2 flex flex-col border-r">
					<Conversation className="flex-1">
						<ConversationContent className="px-6">
							{messages.length === 0 && !isLoading ? (
								<ConversationEmptyState
									icon={<MessageSquareText className="size-8" />}
									title="Tell me about your pricing"
									description="Describe your ideal pricing model and I'll help you build it. For example: 'I want a freemium model with usage-based pricing for API calls.'"
								/>
							) : (
								<>
									{messages.map((message) => (
										<Message key={message.id} from={message.role}>
											<MessageContent>
												<MessageResponse>{message.content}</MessageResponse>
											</MessageContent>
										</Message>
									))}
									{isLoading && (
										<div className="flex items-center gap-2 text-t3 text-sm">
											<Loader size={14} />
											<span>Generating pricing...</span>
										</div>
									)}
								</>
							)}
						</ConversationContent>
					</Conversation>

					<div className="px-6 pb-6 pt-2 border-t">
						<PromptInput onSubmit={handleSubmit}>
							<PromptInputBody>
								<PromptInputTextarea
									value={input}
									onChange={(e) => setInput(e.target.value)}
									placeholder="Describe your pricing model..."
									disabled={isLoading}
								/>
							</PromptInputBody>
							<PromptInputFooter className="justify-end">
								<PromptInputSubmit disabled={!input.trim() || isLoading} />
							</PromptInputFooter>
						</PromptInput>
					</div>
				</div>

				{/* Right: Pricing Preview */}
				<div className="w-1/2 flex flex-col p-6">
					<div className="mb-4">
						<h2 className="text-sm font-medium text-t2">Preview</h2>
					</div>
					<PricingPreview tiers={pricingTiers} />
					{pricingTiers.length > 0 && (
						<div className="flex justify-end mt-4">
							<Button variant="primary" onClick={handleCopyPlans}>
								Copy plans to Autumn
							</Button>
						</div>
					)}
				</div>
			</div>
		</div>
	);
}
