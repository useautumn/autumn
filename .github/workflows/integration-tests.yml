name: Integration Tests

on:
  workflow_dispatch:
    inputs:
      preview_url:
        description: "Preview environment URL"
        required: true
        type: string
      pr_number:
        description: "PR number"
        required: true
        type: string

jobs:
  test-group-1:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.2

      - name: Install Infisical CLI
        run: |
          curl -1sLf 'https://artifacts-cli.infisical.com/setup.deb.sh' | sudo -E bash
          sudo apt-get update && sudo apt-get install -y infisical

      - name: Authenticate with Infisical
        env:
          INFISICAL_UNIVERSAL_AUTH_CLIENT_ID: ${{ secrets.INFISICAL_UNIVERSAL_AUTH_CLIENT_ID }}
          INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET: ${{ secrets.INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET }}
        run: |
          echo "INFISICAL_TOKEN=$(infisical login --method=universal-auth --client-id=$INFISICAL_UNIVERSAL_AUTH_CLIENT_ID --client-secret=$INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET --silent --plain)" >> $GITHUB_ENV

      - name: Install dependencies
        run: bun install

      - name: Create test results directory
        run: mkdir -p server/test-results

      - name: Run Test Group 1 (Balances)
        env:
          SERVER_URL: ${{ inputs.preview_url }}
        run: infisical run --projectId=$INFISICAL_PROJECT_ID --env=test -- ./scripts/testGroups/g1.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-g1-${{ inputs.pr_number }}
          path: server/test-results/
          retention-days: 7

  test-group-2:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.2

      - name: Install Infisical CLI
        run: |
          curl -1sLf 'https://artifacts-cli.infisical.com/setup.deb.sh' | sudo -E bash
          sudo apt-get update && sudo apt-get install -y infisical

      - name: Authenticate with Infisical
        env:
          INFISICAL_UNIVERSAL_AUTH_CLIENT_ID: ${{ secrets.INFISICAL_UNIVERSAL_AUTH_CLIENT_ID }}
          INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET: ${{ secrets.INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET }}
        run: |
          echo "INFISICAL_TOKEN=$(infisical login --method=universal-auth --client-id=$INFISICAL_UNIVERSAL_AUTH_CLIENT_ID --client-secret=$INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET --silent --plain)" >> $GITHUB_ENV

      - name: Install dependencies
        run: bun install

      - name: Create test results directory
        run: mkdir -p server/test-results

      - name: Run Test Group 2 (Attach)
        env:
          SERVER_URL: ${{ inputs.preview_url }}
        run: infisical run --projectId=$INFISICAL_PROJECT_ID --env=test -- ./scripts/testGroups/g2.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-g2-${{ inputs.pr_number }}
          path: server/test-results/
          retention-days: 7

  cleanup-webhook:
    needs: [test-group-1, test-group-2]
    if: always()
    runs-on: ubuntu-latest
    env:
      INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.2

      - name: Install Infisical CLI
        run: |
          curl -1sLf 'https://artifacts-cli.infisical.com/setup.deb.sh' | sudo -E bash
          sudo apt-get update && sudo apt-get install -y infisical

      - name: Authenticate with Infisical
        env:
          INFISICAL_UNIVERSAL_AUTH_CLIENT_ID: ${{ secrets.INFISICAL_UNIVERSAL_AUTH_CLIENT_ID }}
          INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET: ${{ secrets.INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET }}
        run: |
          echo "INFISICAL_TOKEN=$(infisical login --method=universal-auth --client-id=$INFISICAL_UNIVERSAL_AUTH_CLIENT_ID --client-secret=$INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET --silent --plain)" >> $GITHUB_ENV

      - name: Install dependencies
        run: bun install

      - name: Cleanup Stripe webhook
        env:
          SERVER_URL: ${{ inputs.preview_url }}
        run: infisical run --projectId=$INFISICAL_PROJECT_ID --env=test -- bun scripts/preview/cleanupPreviewWebhook.ts

  report-status:
    needs: [test-group-1, test-group-2]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Report to PR
        uses: actions/github-script@v7
        with:
          script: |
            const g1Status = '${{ needs.test-group-1.result }}';
            const g2Status = '${{ needs.test-group-2.result }}';
            const allPassed = g1Status === 'success' && g2Status === 'success';

            const body = allPassed
              ? 'Integration tests passed!\n- Group 1 (Balances): passed\n- Group 2 (Attach): passed'
              : `Integration tests failed!\n- Group 1 (Balances): ${g1Status === 'success' ? 'passed' : 'failed'}\n- Group 2 (Attach): ${g2Status === 'success' ? 'passed' : 'failed'}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }},
              body
            });
